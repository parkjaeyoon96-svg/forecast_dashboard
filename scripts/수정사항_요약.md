# ✅ KE30 당년 로데이터 정제 스크립트 수정 완료

## 📝 수정 내용

### 1️⃣ 표준제간비 계산 로직 제거 ✅
- ❌ `load_standard_cost_ratio()` 함수 제거
- ❌ 표준제간비 계산 로직 제거
- ❌ 마스터 파일 참조 제거
- ✅ 순수하게 집계만 수행

### 2️⃣ 파일명 규칙 변경 ✅

#### 변경 전:
```
CSV 변환 파일: ke30_당년_로데이터.csv
정제 완료 파일: ke30_당년_정제완료.csv
```

#### 변경 후:
```
CSV 변환 파일: [원본파일명].csv
정제 완료 파일: [원본파일명]_전처리완료.csv
```

#### 예시:
```
원본: C:\ke30\ke30_20251114_202511.xlsx

생성되는 파일:
→ raw/ke30_20251114_202511.csv              (CSV 변환)
→ raw/ke30_20251114_202511_전처리완료.csv  (정제 완료)
```

---

## 🔄 수정된 작업 흐름

```
[1단계] SAP CBO 티코드
   ↓ 월중손익분석 다운로드
   
[2단계] C:\ke30\ke30_20251114_202511.xlsx
   ↓ 엑셀 파일 저장
   
[3단계] Python 스크립트 실행
   ↓ 
   ├─ 최신 엑셀 파일 자동 감지
   ├─ CSV 변환 → raw/ke30_20251114_202511.csv
   ├─ 브랜드 공란 제거
   ├─ 피벗 집계 (브랜드, 시즌, 채널, 고객, PH01-3)
   └─ 저장 → raw/ke30_20251114_202511_전처리완료.csv ⭐
   
[4단계] 정제 완료 파일 사용
   ↓ 대시보드 데이터 연결
```

---

## 📊 처리 내용

### ✅ 수행하는 작업
1. **엑셀 → CSV 변환** (원본 파일명 유지)
2. **브랜드 공란 제거**
3. **피벗 집계**
   - 집계 기준: 브랜드, 시즌, 유통채널, 고객, PH01-3
   - 집계 방식: SUM (합계)
   - 집계 대상: 9개 값 컬럼

### ❌ 제거된 작업
- ~~표준제간비 계산~~
- ~~마스터 파일 로드~~

---

## 🚀 실행 방법

### 방법 1: 배치 파일 (추천)
```
당년데이터_처리실행.bat 더블클릭
```

### 방법 2: 명령어
```bash
cd C:\Users\AD0283\Desktop\AIproject\Project_Forcast
python scripts/process_ke30_current_year.py
```

---

## 📈 실행 결과 예시

```
============================================================
KE30 당년 로데이터 정제 스크립트
============================================================
실행 시각: 2025-11-14 15:30:25

✅ 최신 파일 발견: ke30_20251114_202511.xlsx

📥 엑셀 파일 읽는 중: C:\ke30\ke30_20251114_202511.xlsx
   - 원본 데이터: 15234행 × 42열
✅ CSV 변환 완료: raw/ke30_20251114_202511.csv

🔄 데이터 전처리 시작...
   원본: 15234행
   브랜드 공란 제거: 15234행 → 15180행 (54행 삭제)
   집계 기준 (행): ['브랜드', '시즌', '유통채널', '고객', 'PH01-3']
   집계 대상 (값): 9개 컬럼
   집계 완료: 8432행

✅ 정제 완료 파일 저장: raw/ke30_20251114_202511_전처리완료.csv
   최종 데이터: 8,432행 × 14열

============================================================
📊 처리 결과 요약
============================================================
✅ 원본 파일: ke30_20251114_202511.xlsx
✅ CSV 변환 파일: ke30_20251114_202511.csv
✅ 정제 완료 파일: ke30_20251114_202511_전처리완료.csv
✅ 최종 행 수: 8,432행
✅ 컬럼 수: 14개

📌 브랜드별 집계:
   M: 3,245행
   I: 2,187행
   X: 1,534행
   V: 987행

🎉 완료!
```

---

## 📁 생성되는 파일

### 예시 1: ke30_20251114_202511.xlsx 처리 시
```
raw/
├── ke30_20251114_202511.csv              ← CSV 변환
└── ke30_20251114_202511_전처리완료.csv   ← 정제 완료 ⭐
```

### 예시 2: ke30_20251115_202511.xlsx 처리 시
```
raw/
├── ke30_20251115_202511.csv              ← CSV 변환
└── ke30_20251115_202511_전처리완료.csv   ← 정제 완료 ⭐
```

### 파일명 패턴
```
원본:           ke30_[날짜]_[연월].xlsx
CSV 변환:       ke30_[날짜]_[연월].csv
정제 완료:      ke30_[날짜]_[연월]_전처리완료.csv
```

---

## 📊 출력 파일 구조

### ke30_20251114_202511_전처리완료.csv

```csv
브랜드,시즌,유통채널,고객,PH01-3,합계 : 1. 매출액 Actual,...
M,25F,백화점,현대백화점,PH01,10000000,...
M,25F,면세점,신라면세점,PH02,20000000,...
I,25N,직영점,강남점,PH01,15000000,...
X,25F,백화점,롯데백화점,PH03,8000000,...
...
```

**특징:**
- ✅ UTF-8 인코딩
- ✅ 브랜드 공란 없음
- ✅ 중복 제거 (집계 완료)
- ✅ 원본 파일명 기반 자동 명명
- ❌ 표준제간비 컬럼 없음 (제거됨)

---

## 🎯 다음 단계

1. ✅ **당년 로데이터 정제** (완료)
2. 🔜 **전년 로데이터 정제** (비슷한 방식)
3. 🔜 **계획 데이터 처리**
4. 🔜 **KPI 계산** (당년, 전년, 계획 활용)
5. 🔜 **차트 데이터 생성**
6. 🔜 **data.js 통합**

---

## 🔍 주요 변경 사항

### 코드 변경
```python
# 변경 전
excel_path = find_latest_ke30_file()
csv_path = "raw/ke30_당년_로데이터.csv"
processed_path = "raw/ke30_당년_정제완료.csv"
df_cost_ratio = load_standard_cost_ratio()
df_processed = preprocess_ke30_data(df_raw, df_cost_ratio)

# 변경 후
excel_path, base_filename = find_latest_ke30_file()
csv_path = f"raw/{base_filename}.csv"
processed_path = f"raw/{base_filename}_전처리완료.csv"
df_processed = preprocess_ke30_data(df_raw)
```

### 제거된 함수
- `load_standard_cost_ratio()` - 전체 제거
- `preprocess_ke30_data()` - 표준제간비 계산 부분 제거

---

## ✅ 수정 완료 체크리스트

- [x] 표준제간비 계산 로직 제거
- [x] 마스터 파일 참조 제거
- [x] 파일명을 원본 기반으로 변경
- [x] CSV 변환 파일명: `[원본명].csv`
- [x] 정제 파일명: `[원본명]_전처리완료.csv`
- [x] 배치 파일 수정
- [x] 문서 업데이트

---

**수정 완료!** 🎉

이제 스크립트는:
1. 원본 파일명을 유지하며
2. 표준제간비 없이 순수 집계만 수행합니다!

실행해보세요! 🚀





