# 📊 트리맵 데이터 정제 및 연결 가이드

## 🎯 목적
전처리 완료된 KE30 데이터를 채널별/아이템별 트리맵 형식으로 변환하여 Dashboard.html에 연결합니다.

---

## 📋 작업 흐름

```
1. 전처리완료 CSV 파일 준비
   (ke30_YYYYMMDD_YYYYMM_전처리완료.csv)
   ↓
2. Python 스크립트 실행
   (트리맵데이터_처리실행.bat)
   ↓
3. 집계 처리:
   - 브랜드별 그룹화
   - 채널별 그룹화
   - 아이템별 그룹화
   - TAG가, 실판매액 합계
   ↓
4. JSON 변환
   (Dashboard.html 형식에 맞게)
   ↓
5. public/treemap_data.js 생성
   ↓
6. Dashboard.html에 자동 반영
```

---

## 🚀 실행 방법

### 방법 1: 배치 파일 (추천) ⭐
```
트리맵데이터_처리실행.bat 더블클릭
```

### 방법 2: 명령어
```bash
cd C:\Users\AD0283\Desktop\AIproject\Project_Forcast
python scripts/process_treemap_data.py
```

---

## 📊 데이터 집계 상세

### 입력 데이터
```
전처리완료 CSV:
- 브랜드
- 유통채널
- PH01-3 (아이템분류)
- 판매금액(TAG가) Actual
- 실판매액 Actual
```

### 집계 방식
```python
GROUP BY:
  - 브랜드
  - 유통채널 (채널명)
  - PH01-3 (아이템분류)

SUM:
  - 판매금액(TAG가)
  - 실판매액 Actual
```

### 출력 형식
```javascript
{
  "브랜드코드": {
    "채널명": {
      "아이템명": 실판매액(원)
    }
  }
}
```

---

## 📁 출력 파일 구조

### treemap_data.js

```javascript
// 트리맵 데이터 (자동 생성)
window.channelItemSalesData = {
  "M": {  // MLB
    "백화점": {
      "Acc_etc": 21562060,
      "Bag": 962703160,
      "Headwear": 2036653800,
      "Shoes": 1601231230,
      "과시즌의류": 112463110,
      "당시즌의류": 2586454600
    },
    "면세점": {
      "Acc_etc": 10917700,
      "Bag": 353734650,
      // ...
    },
    // ... 다른 채널
  },
  "I": {  // MLB KIDS
    // ...
  },
  // ... 다른 브랜드
};

// 브랜드 코드 매핑
window.brandCodeMap = {
  'MLB': 'M',
  'MLB KIDS': 'I',
  'DISCOVERY': 'X',
  'DUVETICA': 'V',
  'SERGIO': 'ST',
  'SUPRA': 'W'
};
```

---

## 🔗 Dashboard.html 연결

### 자동 연결 (추천)
```bash
python scripts/inject_treemap_script.py
```

### 수동 연결
Dashboard.html의 `<head>` 섹션에 추가:

```html
<head>
  <!-- 기존 스크립트들 -->
  <script defer src="./data.js"></script>
  <script defer src="./treemap_data.js"></script>  <!-- 이 줄 추가 -->
</head>
```

---

## 📈 실행 결과 예시

```
============================================================
트리맵 데이터 정제 스크립트
============================================================
실행 시각: 2025-11-14 16:30:25

✅ 최신 파일 발견: ke30_20251114_202511_전처리완료.csv

📥 CSV 파일 읽는 중: C:\...\ke30_20251114_202511_전처리완료.csv
   원본 데이터: 8432행 × 14열
   TAG가 컬럼: 합계 : 판매금액(TAG가) Actual
   실판매액 컬럼: 합계 : 실판매액 Actual
   집계 기준: ['브랜드', '유통채널', 'PH01-3']
✅ 집계 완료: 850행
   총 TAG가: 125,430,500,000원
   총 실판매액: 88,160,000,000원

🔄 트리맵 JSON 변환 중...
   ✅ M (M): 10개 채널
   ✅ I (I): 9개 채널
   ✅ X (X): 8개 채널
   ✅ V (V): 6개 채널
   ✅ ST (ST): 8개 채널
   ✅ W (W): 4개 채널

📝 JavaScript 파일 생성 중...
✅ JavaScript 파일 저장: public/treemap_data.js

============================================================
📊 트리맵 데이터 요약
============================================================

🏷️  MLB (M)
   채널 수: 10개
   아이템 수: 58개
   총 매출: 34,930,000,000원 (349.3억원)
     - 면세점: 110.2억원 (6개 아이템)
     - 백화점: 82.6억원 (6개 아이템)
     - 대리점: 63.3억원 (6개 아이템)
     - RF: 29.2억원 (6개 아이템)
     - 직영점(가두): 27.4억원 (6개 아이템)

🏷️  MLB KIDS (I)
   채널 수: 9개
   아이템 수: 52개
   총 매출: 7,950,000,000원 (79.5억원)
     - 대리점: 34.2억원 (6개 아이템)
     - 백화점: 15.8억원 (6개 아이템)
     - 면세점: 9.8억원 (5개 아이템)
     - 제휴몰: 8.5억원 (6개 아이템)
     - 사입: 7.2억원 (4개 아이템)

🏷️  DISCOVERY (X)
   채널 수: 8개
   아이템 수: 48개
   총 매출: 23,697,000,000원 (236.9억원)

🏷️  DUVETICA (V)
   채널 수: 6개
   아이템 수: 32개
   총 매출: 24,089,000,000원 (240.9억원)

🏷️  SERGIO (ST)
   채널 수: 8개
   아이템 수: 45개
   총 매출: 5,431,000,000원 (54.3억원)

🏷️  SUPRA (W)
   채널 수: 4개
   아이템 수: 18개
   총 매출: 1,503,000,000원 (15.0억원)

🎉 완료!
   생성된 파일: public/treemap_data.js

📋 브랜드별 데이터 개수:
   MLB (M): 10개 채널, 58개 아이템
   MLB KIDS (I): 9개 채널, 52개 아이템
   DISCOVERY (X): 8개 채널, 48개 아이템
   DUVETICA (V): 6개 채널, 32개 아이템
   SERGIO (ST): 8개 채널, 45개 아이템
   SUPRA (W): 4개 채널, 18개 아이템
```

---

## 🔍 데이터 매핑

### 브랜드 코드
```
M  → MLB
I  → MLB KIDS
X  → DISCOVERY
V  → DUVETICA
ST → SERGIO
W  → SUPRA
```

### 채널명 (Dashboard.html 기준)
```
백화점
면세점
대리점
직영점(가두)
직영몰
자사몰
제휴몰
사입
아울렛
RF (MLB 전용)
기타
```

### 아이템 분류 (PH01-3)
```
Acc_etc       → 기타ACC
Bag           → 가방
Headwear      → 모자
Shoes         → 신발
과시즌의류    → 과시즌의류
당시즌의류    → 당시즌의류
차시즌의류    → 차시즌의류
```

---

## 📊 Dashboard.html에서 사용

트리맵 데이터는 자동으로 `window.channelItemSalesData` 변수에 로드됩니다.

### 사용 예시
```javascript
// 브라우저 콘솔에서 확인
console.log(window.channelItemSalesData);

// MLB 브랜드의 백화점 채널 데이터
const mlbDeptStore = window.channelItemSalesData['M']['백화점'];
console.log(mlbDeptStore);

// 출력:
// {
//   "Acc_etc": 21562060,
//   "Bag": 962703160,
//   "Headwear": 2036653800,
//   ...
// }
```

### 트리맵 렌더링
Dashboard.html의 `renderTreemap()` 함수가 자동으로 이 데이터를 사용합니다:
- 채널별 매출구성 트리맵
- 아이템별 매출구성 트리맵
- 드릴다운 기능

---

## 🔄 데이터 업데이트 프로세스

### 1. 당년 데이터 전처리
```bash
당년데이터_처리실행.bat
```

### 2. 트리맵 데이터 생성
```bash
트리맵데이터_처리실행.bat
```

### 3. Dashboard 확인
```bash
npm run dev
# http://localhost:3000/dashboard
```

---

## 🐛 오류 해결

### 오류 1: "전처리완료 파일이 없습니다"
```bash
# 해결: 먼저 당년 데이터 전처리 실행
당년데이터_처리실행.bat
```

### 오류 2: "'판매금액(TAG가)' 컬럼을 찾을 수 없습니다"
```bash
# 해결: CSV 파일의 컬럼명 확인
# 스크립트는 유사 컬럼명 자동 매칭 시도
# 로그에서 "사용 가능한 컬럼" 확인
```

### 오류 3: "treemap_data.js가 로드되지 않습니다"
```bash
# 확인 1: 파일 존재 여부
dir public\treemap_data.js

# 확인 2: Dashboard.html에 스크립트 추가 여부
# 수동 확인 또는 자동 추가:
python scripts\inject_treemap_script.py

# 확인 3: 브라우저 콘솔에서 확인
# F12 → Console
console.log(window.channelItemSalesData);
```

### 오류 4: "데이터가 0원입니다"
```bash
# 원인: 실판매액이 음수이거나 0
# 스크립트는 양수만 포함 (음수 제외)
# 
# 확인:
# 1. 원본 CSV에서 실판매액 합계 확인
# 2. 브랜드/채널/아이템 조합이 올바른지 확인
```

---

## 📝 생성된 파일

```
Project_Forcast/
├── scripts/
│   ├── process_treemap_data.py        ⭐ 트리맵 데이터 생성
│   └── inject_treemap_script.py       🔧 자동 스크립트 추가
│
├── 트리맵데이터_처리실행.bat          🚀 빠른 실행
│
├── public/
│   ├── Dashboard.html                 📄 대시보드
│   ├── data.js                        📊 기존 데이터
│   └── treemap_data.js                ⭐ 트리맵 데이터 (신규)
│
└── raw/
    └── ke30_YYYYMMDD_YYYYMM_전처리완료.csv  (입력)
```

---

## 🎯 다음 단계

1. ✅ **당년 데이터 전처리** (완료)
2. ✅ **트리맵 데이터 생성** (완료)
3. 🔜 **전년 데이터 전처리**
4. 🔜 **계획 데이터 처리**
5. 🔜 **KPI 계산**
6. 🔜 **전체 data.js 통합**

---

## 💡 특징

### 1. 자동 파일 감지
- raw 폴더에서 최신 전처리완료 파일 자동 선택
- 파일명 패턴 자동 인식

### 2. 유연한 컬럼 매칭
- "판매금액(TAG가)" ≈ "TAG가" ≈ "판매금액"
- "실판매액" ≈ "실판매액 Actual" 자동 인식

### 3. 데이터 검증
- 음수 값 제외
- 0원 데이터 제외
- 브랜드별/채널별 요약 제공

### 4. Dashboard.html 호환
- Plotly.js 트리맵 형식
- 기존 channelItemSalesData 구조 유지
- 드릴다운 기능 지원

---

## 📞 참고

- **상세 코드**: `scripts/process_treemap_data.py`
- **Dashboard 구조**: `public/Dashboard.html` (line 4842~)
- **트리맵 함수**: `renderTreemap()`, `getChannelDrilldownData()`, `getItemDrilldownData()`

---

**작성일:** 2025-11-14  
**버전:** 1.0  
**상태:** ✅ 완료

---

## 🚀 지금 바로 시작하기

```bash
# 1. 당년 데이터 전처리 (아직 안 했다면)
당년데이터_처리실행.bat

# 2. 트리맵 데이터 생성
트리맵데이터_처리실행.bat

# 3. Dashboard 확인
npm run dev
# → http://localhost:3000/dashboard

# 완료! 🎉
# 채널별/아이템별 트리맵이 실제 데이터로 표시됩니다!
```





