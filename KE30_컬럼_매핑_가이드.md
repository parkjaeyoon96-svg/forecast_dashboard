# 📊 KE30 컬럼 자동 매핑 가이드

실제 SAP KE30 파일의 컬럼명이 다를 때 자동으로 매핑하는 시스템입니다.

---

## 🎯 문제 상황

SAP KE30 데이터는 회사마다 컬럼명이 다릅니다:

| 우리 시스템 | 회사 A | 회사 B | 회사 C |
|------------|--------|--------|--------|
| 자재코드 | Material | MAT_CODE | 품번 |
| 매출액 | Revenue | SALES_AMOUNT | 순매출액 |
| 영업이익 | Operating Profit | EBIT | OP |

이 시스템은 **자동으로 컬럼명을 인식하고 매핑**합니다!

---

## 🚀 사용 방법

### 방법 1: 자동 매핑 (추천) ⭐

#### STEP 1: 파일 업로드
```
raw/sap_ke30.csv 에 파일 저장
```

#### STEP 2: 컬럼 분석 API 호출
```
http://localhost:3000/api/analyze-columns?file=raw/sap_ke30.csv
```

**응답 예시:**
```json
{
  "success": true,
  "analysis": {
    "actualHeaders": ["Material", "Revenue", "EBIT", "Date"],
    "detected": [
      "Material → 자재코드",
      "Revenue → 매출액",
      "EBIT → 영업이익",
      "Date → 일자"
    ],
    "validation": {
      "valid": true,
      "missing": [],
      "warnings": []
    }
  }
}
```

#### STEP 3: 대시보드 확인
```
http://localhost:3000/dashboard
```

자동으로 매핑된 데이터가 표시됩니다! ✅

---

### 방법 2: 설정 파일 수정

컬럼명이 특이한 경우 설정 파일에 추가할 수 있습니다.

**파일:** `config/columnMapping.json`

```json
{
  "sap_ke30": {
    "mappings": {
      "매출액": [
        "매출액",
        "Revenue",
        "Sales",
        "REVENUE",
        "순매출액",
        "실판매출",
        "당사매출액"  ← 여기에 추가!
      ],
      "자재코드": [
        "자재코드",
        "Material",
        "MAT_CODE",
        "품번",
        "제품코드"    ← 여기에 추가!
      ]
    }
  }
}
```

**변경 후:**
1. 파일 저장
2. 개발 서버 재시작 (Ctrl+C → `npm run dev`)
3. 대시보드 새로고침

---

## 🔍 지원하는 컬럼 목록

### 필수 컬럼 (반드시 있어야 함)

| 표준명 | 인식 가능한 이름들 |
|--------|------------------|
| **자재코드** | Material, MAT_CODE, 자재, 품번, Material_Code |
| **자재명** | Material Name, MAT_NAME, 자재명칭, 품명, 제품명 |
| **매출액** | Revenue, Sales, REVENUE, 순매출액, 실판매출 |

### 선택 컬럼 (있으면 좋음)

| 표준명 | 인식 가능한 이름들 |
|--------|------------------|
| 브랜드 | Brand, BRAND, 브랜드명 |
| 수량 | Quantity, QTY, 판매수량 |
| 매출원가 | COGS, Cost of Sales, 원가 |
| 판매관리비 | SG&A, Selling Expense, 판관비 |
| 영업이익 | Operating Profit, EBIT, OP |
| 직접이익 | Direct Profit, Gross Profit, GP |
| 일자 | Date, DATE, 거래일자, 전표일자 |
| 카테고리 | Category, CATEGORY, 제품군 |
| 채널 | Channel, CHANNEL, 판매채널 |

---

## 🧪 실제 예제

### 예제 1: 한글 컬럼명

**실제 CSV:**
```csv
자재코드,자재명,수량,매출액,영업이익,일자
MAT001,제품A,100,10000000,2000000,2024-11-01
```

**매핑 결과:**
```
✅ 자재코드 → 자재코드 (신뢰도: 100%)
✅ 자재명 → 자재명 (신뢰도: 100%)
✅ 수량 → 수량 (신뢰도: 100%)
✅ 매출액 → 매출액 (신뢰도: 100%)
✅ 영업이익 → 영업이익 (신뢰도: 100%)
✅ 일자 → 일자 (신뢰도: 100%)
```

### 예제 2: 영문 컬럼명

**실제 CSV:**
```csv
Material,Material Name,Quantity,Revenue,EBIT,Date
MAT001,Product A,100,10000000,2000000,2024-11-01
```

**매핑 결과:**
```
✅ 자재코드 → Material (신뢰도: 100%)
✅ 자재명 → Material Name (신뢰도: 100%)
✅ 수량 → Quantity (신뢰도: 100%)
✅ 매출액 → Revenue (신뢰도: 100%)
✅ 영업이익 → EBIT (신뢰도: 100%)
✅ 일자 → Date (신뢰도: 100%)
```

### 예제 3: 혼합 컬럼명

**실제 CSV:**
```csv
MAT_CODE,제품명,QTY,SALES_AMOUNT,Operating_Profit,거래일자
MAT001,제품A,100,10000000,2000000,2024-11-01
```

**매핑 결과:**
```
✅ 자재코드 → MAT_CODE (신뢰도: 90%)
✅ 자재명 → 제품명 (신뢰도: 100%)
✅ 수량 → QTY (신뢰도: 100%)
✅ 매출액 → SALES_AMOUNT (신뢰도: 90%)
⚠️ 영업이익 → Operating_Profit (신뢰도: 70%)
✅ 일자 → 거래일자 (신뢰도: 100%)
```

---

## 🔧 고급 사용법

### 1. 컬럼 분석 상세 보기

브라우저에서 접속:
```
http://localhost:3000/api/analyze-columns?file=raw/sap_ke30.csv
```

**응답 내용:**
- `actualHeaders`: 실제 CSV의 컬럼명
- `detected`: 자동 감지된 매핑
- `suggestions`: 매핑 제안
- `unmappedColumns`: 매핑되지 않은 컬럼
- `validation`: 필수 컬럼 누락 여부
- `sampleData`: 샘플 데이터 5행

### 2. 터미널에서 매핑 로그 확인

개발 서버 실행 중:
```
npm run dev
```

대시보드 접속 시 터미널에 표시됨:
```
📂 SAP KE30 파일 로드: 100행
🔄 컬럼 매핑 완료: 8개 컬럼
컬럼 매핑 결과:
  ✅ 자재코드 → Material (신뢰도: 100%)
  ✅ 자재명 → Product_Name (신뢰도: 90%)
  ✅ 매출액 → Revenue (신뢰도: 100%)
  ⚠️ 영업이익 → OP (신뢰도: 70%)
✅ SAP 데이터 처리 완료: 4개 브랜드
```

### 3. 브라우저 콘솔에서 테스트

대시보드(F12) → Console:
```javascript
// 컬럼 분석
fetch('/api/analyze-columns?file=raw/sap_ke30.csv')
  .then(r => r.json())
  .then(data => {
    console.log('실제 컬럼:', data.analysis.actualHeaders);
    console.log('감지된 매핑:', data.analysis.detected);
    console.log('샘플 데이터:', data.sampleData);
  });

// 실제 데이터 로드
fetch('/api/load-data')
  .then(r => r.json())
  .then(data => {
    console.log('로딩 로그:', data.metadata.loadingLog);
  });
```

---

## ❓ 문제 해결

### 문제 1: "필수 컬럼 누락" 오류

**증상:**
```
⚠️ 필수 컬럼 누락: 매출액
```

**원인:**
CSV에 매출액 컬럼이 없거나 이름이 너무 다름

**해결:**
1. 컬럼 분석 API로 실제 컬럼명 확인:
   ```
   http://localhost:3000/api/analyze-columns?file=raw/sap_ke30.csv
   ```

2. `config/columnMapping.json`에 컬럼명 추가:
   ```json
   "매출액": [
     "매출액",
     "Revenue",
     "당사의이상한컬럼명"  ← 추가
   ]
   ```

### 문제 2: "낮은 신뢰도" 경고

**증상:**
```
⚠️ 경고: 영업이익: 낮은 신뢰도 (70%)
```

**의미:**
컬럼명이 부분적으로만 일치

**해결:**
- 데이터는 정상적으로 로드됨
- 정확성을 높이려면 `config/columnMapping.json`에서 해당 컬럼명을 첫 번째로 이동

### 문제 3: 특정 컬럼만 매핑 안됨

**증상:**
```
unmappedColumns: ["CUSTOM_FIELD"]
```

**해결:**
필수 컬럼이 아니면 무시해도 됨. 사용하려면:

1. `config/columnMapping.json`에 새 표준 컬럼 추가:
   ```json
   "내컬럼": ["CUSTOM_FIELD", "Custom Field"]
   ```

2. `lib/columnMapper.ts`의 `StandardKE30Data` 인터페이스에 추가:
   ```typescript
   export interface StandardKE30Data {
     // ... 기존 필드들
     내컬럼?: string;  // 추가
   }
   ```

---

## 📊 매핑 우선순위

컬럼명은 **설정 파일의 순서**대로 매칭됩니다:

```json
"매출액": [
  "매출액",        // 1순위 (신뢰도 100%)
  "Revenue",      // 2순위 (신뢰도 90%)
  "Sales",        // 3순위 (신뢰도 80%)
  "REVENUE"       // 4순위 (신뢰도 70%)
]
```

**권장:**
- 가장 많이 사용하는 컬럼명을 첫 번째에 배치
- 영문/한글 모두 지원

---

## 🎓 동작 원리

### 1. 정규화 (Normalization)
```
"Material_Code" → "materialcode"
"매출 액"       → "매출액"
"REVENUE"      → "revenue"
```

### 2. 매칭 (Matching)
- **정확 일치**: 정규화 후 완전히 같음 → 신뢰도 100%
- **부분 일치**: 포함 관계 → 신뢰도 70%
- **불일치**: 매핑 안됨

### 3. 검증 (Validation)
- 필수 컬럼 체크 (자재코드, 자재명, 매출액)
- 신뢰도 체크 (80% 이하면 경고)

### 4. 변환 (Transformation)
```
실제 데이터:
{ "Revenue": 10000000, "Material": "MAT001" }

↓ 매핑 후

표준 데이터:
{ "매출액": 10000000, "자재코드": "MAT001" }
```

---

## ✅ 체크리스트

CSV 파일 준비 전:

- [ ] CSV 첫 줄이 컬럼명인지 확인
- [ ] 필수 컬럼 포함 확인 (자재코드, 자재명, 매출액)
- [ ] 숫자에 천단위 쉼표 있어도 OK
- [ ] 인코딩 UTF-8 또는 CP949

매핑 확인:

- [ ] `/api/analyze-columns` 접속해서 매핑 확인
- [ ] 필수 컬럼이 모두 `detected`에 있는지 확인
- [ ] 신뢰도가 80% 이상인지 확인
- [ ] 대시보드에서 데이터 정상 표시 확인

---

## 💡 팁

### Tip 1: 샘플 파일로 먼저 테스트
```powershell
# 샘플 파일 매핑 테스트
http://localhost:3000/api/analyze-columns?file=raw/sap_ke30_sample.csv
```

### Tip 2: 컬럼명을 표준에 가깝게 변경
CSV를 Excel로 열어서 컬럼명을 아래와 같이 변경:
- `Material` → `자재코드`
- `Revenue` → `매출액`
- `EBIT` → `영업이익`

### Tip 3: 회사 표준 매핑 만들기
`config/columnMapping.json`을 회사 표준으로 커스터마이징하면, 모든 파일에 자동 적용됩니다.

---

## 📚 관련 파일

| 파일 | 역할 |
|------|------|
| `config/columnMapping.json` | 컬럼 매핑 설정 |
| `lib/columnMapper.ts` | 매핑 로직 |
| `app/api/analyze-columns/route.ts` | 컬럼 분석 API |
| `app/api/load-data/route.ts` | 데이터 로드 API (매핑 포함) |

---

## 🎉 요약

1. **CSV 파일을 `raw/` 폴더에 저장**
2. **자동 매핑이 실행됨** (컬럼명 자동 인식)
3. **대시보드에서 확인**
4. **필요시 `config/columnMapping.json` 수정**

**더 이상 컬럼명 걱정 없습니다!** ✅

---

**작성일**: 2024-11-14  
**버전**: 1.0.0





