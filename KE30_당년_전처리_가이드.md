# KE30 당년 로데이터 전처리 가이드

## 📋 개요

SAP KE30 엑셀 파일을 읽어서 CSV로 변환하고, 마스터 파일을 활용하여 데이터를 정제하는 자동화 스크립트입니다.

---

## 🔄 처리 흐름

### 1️⃣ 엑셀 파일 준비
```
위치: C:\ke30\
파일명 예시: ke30_20251114_202511.xlsx
```

### 2️⃣ 자동 처리 단계

#### **Step 1: 엑셀 → CSV 변환**
- 최신 ke30 엑셀 파일 자동 감지
- CSV로 변환하여 저장
- 파일명: `ke30_YYYYMMDD_YYYYMM.csv`
- 저장 위치: `raw/YYYYMM/present/YYYYMMDD/`

#### **Step 2: 데이터 필터링**

##### 2-1) 브랜드 공란 제거
- '브랜드' 컬럼이 비어있는 행 삭제
- 빈 문자열도 제거

##### 2-2) PH01-1이 'E0100'인 행 제거
- PH01-1 컬럼 값이 'E0100'인 행 삭제

##### 2-3) 유통채널이 '9'인 행 제거
- 유통채널 컬럼 값이 '9' 또는 '9.0'인 행 삭제

##### 2-4) 유통코드(고객)가 '100369'인 행 제거
- 고객 컬럼 값이 '100369' 또는 '100369.0'인 행 삭제

##### 2-5) 아이템코드 필드 생성
- 상품코드에서 아이템코드 추출
- 브랜드가 'ST'인 경우: 상품코드의 8번째부터 2글자
- 그 외: 상품코드의 7번째부터 2글자

#### **Step 3: 피벗 집계**

**집계 기준 (행):**
- 브랜드
- 시즌
- 유통채널
- 고객
- PH01-1
- PH01-2
- PH01-3
- 아이템코드

**집계 대상 (값):**
- 합계 : 1. 매출액 Actual
- 합계 : 제품/상품 매출액 Actual
- 합계 : 판매금액(TAG가)
- 합계 : 실판매액
- 합계 : 실판매액(V-)
- 합계 : 수수료차감매출 Actual
- 합계 : 출고매출액(V-) Actual
- 합계 : 2. 매출원가 Actual
- 합계 : 표준 매출원가

#### **Step 4: 마스터 파일 매핑**

##### 1) 채널명 추가
```python
로직:
① 고객번호가 채널마스터.csv의 SAP_CD 또는 MAIN_CD에 있으면 → 'RF'
② 그 외는 유통채널 코드로 채널명 매핑
```

**마스터 파일:** `Master/채널마스터.csv`

**예시:**
| 유통채널 | 고객 | → 채널명 |
|---------|------|---------|
| 3 | 100466 | RF (SAP_CD에 존재) |
| 3 | 101998 | 직영점(가두) (유통채널 3 매핑) |

##### 2) 아이템_대분류 추가
```python
로직:
PH01-3 코드로 아이템마스터.csv의 PRDT_HRRC1_NM 매핑
```

**마스터 파일:** `Master/아이템마스터.csv`

**예시:**
| PH01-3 | → 아이템_대분류 |
|--------|----------------|
| A0100A0140A0140003 | Headwear |
| A0100A0150A0150005 | Shoes |

##### 3) 아이템_중분류 추가
```python
로직:
- PH01-1이 'L0100'인 경우:
  * 시즌이 '25F'면 → '당시즌의류'
  * 시즌에 '26'이 포함되면 → '차시즌의류'
  * 그 외 → '과시즌의류'
  
- PH01-1이 'A0100'인 경우:
  * PH01-3로 아이템마스터.csv의 PRDT_HRRC2_NM 매핑
```

**예시:**
| 브랜드 | 시즌 | PH01-1 | PH01-3 | → 아이템_중분류 |
|-------|------|--------|--------|----------------|
| M | 25F | L0100 | ... | 당시즌의류 |
| M | 26S | L0100 | ... | 차시즌의류 |
| M | 24N | L0100 | ... | 과시즌의류 |
| M | 21N | A0100 | A0100A0140A0140003 | Headwear |

##### 4) 아이템_소분류 추가
```python
로직:
PH01-3 코드로 아이템마스터.csv의 PRDT_HRRC3_NM 매핑
```

**예시:**
| PH01-3 | → 아이템_소분류 |
|--------|----------------|
| A0100A0140A0140003 | 운동모 |
| A0100A0150A0150005 | 신발 |

**참고:** 아이템코드는 Step 2에서 이미 생성되어 집계 기준에 포함되어 있으므로, Step 4에서는 추가하지 않습니다.

#### **Step 5: 최종 파일 저장**
```
파일명: ke30_YYYYMMDD_YYYYMM_전처리완료.csv
위치: raw/YYYYMM/present/YYYYMMDD/
인코딩: UTF-8 with BOM
```

---

## 🚀 실행 방법

### 방법 1: 배치 파일 실행 (권장)
```
당년데이터_처리실행.bat 더블클릭
```

### 방법 2: 명령 프롬프트
```cmd
cd C:\Users\AD0283\Desktop\AIproject\Project_Forcast
python scripts\process_ke30_current_year.py
```

---

## 📁 필요한 파일 구조

```
Project_Forcast/
├── scripts/
│   └── process_ke30_current_year.py
├── Master/
│   ├── 채널마스터.csv       (필수)
│   └── 아이템마스터.csv     (필수)
├── raw/                      (자동 생성)
│   └── YYYYMM/
│       └── present/
│           └── YYYYMMDD/
│               ├── ke30_YYYYMMDD_YYYYMM.csv
│               └── ke30_YYYYMMDD_YYYYMM_전처리완료.csv
└── C:\ke30/
    └── ke30_YYYYMMDD_YYYYMM.xlsx
```

---

## 📊 출력 예시

### 실행 결과
```
============================================================
KE30 당년 로데이터 정제 스크립트
============================================================
실행 시각: 2025-11-18 14:30:00

📁 마스터 파일 로드 중...
✅ 채널 마스터 로드: 15행
✅ 아이템 마스터 로드: 250행

✅ 최신 파일 발견: ke30_20251114_202511.xlsx

📥 엑셀 파일 읽는 중: C:\ke30\ke30_20251114_202511.xlsx
   - 원본 데이터: 45,231행 × 85열
✅ CSV 변환 완료: raw\202511\present\20251114\ke30_20251114_202511.csv

🔄 데이터 전처리 시작...
   원본: 45,231행
   브랜드 공란 제거: 45,231행 → 44,998행 (233행 삭제)
   PH01-1='E0100' 제거: 44,998행 → 44,850행 (148행 삭제)
   유통채널='9' 제거: 44,850행 → 44,720행 (130행 삭제)
   유통코드='100369' 제거: 44,720행 → 44,680행 (40행 삭제)
   아이템코드 필드 생성 완료
   집계 기준 (행): ['브랜드', '시즌', '유통채널', '고객', 'PH01-1', 'PH01-2', 'PH01-3', '아이템코드']
   집계 대상 (값): 9개 컬럼
   집계 완료: 42,150행

🔄 마스터 파일 매핑 시작...
   1) 채널명 매핑...
      ✅ 채널명 추가 완료
   2) 아이템_대분류 매핑...
      ✅ 아이템_대분류 추가 완료
   3) 아이템_중분류 계산...
      ✅ 아이템_중분류 추가 완료
   4) 아이템_소분류 매핑...
      ✅ 아이템_소분류 추가 완료

✅ 마스터 매핑 완료! 총 42,150행

✅ 정제 완료 파일 저장: raw\202511\present\20251114\ke30_20251114_202511_전처리완료.csv
   최종 데이터: 42,150행 × 23열

============================================================
📊 처리 결과 요약
============================================================
✅ 원본 파일: ke30_20251114_202511.xlsx
✅ CSV 변환 파일: ke30_20251114_202511.csv
✅ 정제 완료 파일: ke30_20251114_202511_전처리완료.csv
✅ 최종 행 수: 42,150행
✅ 컬럼 수: 23개

🎉 완료!
```

---

## ❗ 주의사항

### 1. 마스터 파일 위치
```
Master/채널마스터.csv
Master/아이템마스터.csv
```
이 두 파일이 반드시 있어야 합니다!

### 2. 채널마스터.csv 구조
```csv
채널번호,채널명,,MAIN_CD,SAP_CD,매장명,구분
RF,RF,,649,100027,부산광복(대-위),RF
1,백화점,,155,100178,롯데본점,RF
2,면세점,,524,100444,가로수길(직),RF
3,직영점(가두),,526,100466,홍대(직),RF
...
```

### 3. 아이템마스터.csv 구조
```csv
PH01-3,PRDT_HRRC1_NM,PRDT_HRRC2_NM,PRDT_HRRC3_NM
L0100L0110L0110005,의류,Outer,다운점퍼
A0100A0140A0140003,ACC,Headwear,운동모
A0100A0150A0150005,ACC,Shoes,신발
...
```

### 4. KE30 엑셀 파일 위치
```
C:\ke30\ke30_YYYYMMDD_YYYYMM.xlsx
```
파일명 형식을 맞춰주세요!

### 5. 데이터 필터링 규칙
다음 조건에 해당하는 행은 자동으로 제거됩니다:
- 브랜드 컬럼이 비어있는 행
- PH01-1이 'E0100'인 행
- 유통채널이 '9'인 행
- 유통코드(고객)가 '100369'인 행

---

## 🔧 문제 해결

### 문제 1: "채널 마스터 로드 실패"
**원인:** 마스터 파일이 없거나 경로가 잘못됨

**해결:**
```cmd
dir Master\채널마스터.csv
```
파일이 있는지 확인하세요.

### 문제 2: "ke30 엑셀 파일이 없습니다"
**원인:** C:\ke30 폴더에 파일이 없음

**해결:**
```cmd
dir C:\ke30\ke30_*.xlsx
```
파일명이 `ke30_` 로 시작하는지 확인하세요.

### 문제 3: "브랜드 컬럼을 찾을 수 없습니다"
**원인:** KE30 엑셀 파일의 컬럼 구조가 다름

**해결:** 
엑셀 파일에 '브랜드' 컬럼이 있는지 확인하세요.
스크립트는 유사한 컬럼명을 자동으로 찾으려 시도합니다.

### 문제 4: "인코딩 오류"
**원인:** CSV 파일 인코딩 문제

**해결:**
스크립트는 UTF-8-BOM을 사용합니다.
엑셀에서 열 때 문제가 있다면 메모장으로 열어서 인코딩을 확인하세요.

---

## 📝 최종 컬럼 리스트

### 원본 집계 컬럼 (8개)
1. 브랜드
2. 시즌
3. 유통채널
4. 고객
5. PH01-1
6. PH01-2
7. PH01-3
8. 아이템코드 (Step 2에서 생성)

### 값 컬럼 (9개)
9. 합계 : 1. 매출액 Actual
10. 합계 : 제품/상품 매출액 Actual
11. 합계 : 판매금액(TAG가)
12. 합계 : 실판매액
13. 합계 : 실판매액(V-)
14. 합계 : 수수료차감매출 Actual
15. 합계 : 출고매출액(V-) Actual
16. 합계 : 2. 매출원가 Actual
17. 합계 : 표준 매출원가

### 마스터 매핑 컬럼 (4개)
18. 채널명
19. 아이템_대분류
20. 아이템_중분류
21. 아이템_소분류

**총 21개 컬럼** (아이템코드는 집계 기준에 포함되어 있음)

---

## 🎯 다음 단계

전처리가 완료되면 다음 작업을 진행할 수 있습니다:

1. **트리맵 데이터 생성**: `트리맵데이터_처리실행.bat`
2. **KPI 계산**: 전년 데이터, 계획 데이터와 결합
3. **대시보드 연결**: Dashboard.html에 데이터 반영

---

## 📞 지원

문제가 발생하면 다음을 확인하세요:
1. Python 버전 (3.7 이상)
2. 필요한 라이브러리 설치: `pandas`, `openpyxl`
3. 파일 경로 및 권한
4. 마스터 파일 인코딩 (UTF-8)

```cmd
pip install pandas openpyxl
```

---

**마지막 업데이트:** 2025-11-18

