# 전년계획_업데이트.bat 로직 및 내용 정리

## 📋 개요

전년도 데이터와 계획 데이터를 준비하는 전체 프로세스를 실행하는 배치 파일입니다.

---

## 🔧 배치 파일 구조

### 파일: `전년계획_업데이트.bat`

```batch
@echo off
chcp 65001 >nul                    # 코드페이지를 UTF-8로 설정
cd /d "%~dp0"                      # 스크립트 위치로 디렉토리 이동
set PYTHONIOENCODING=utf-8         # Python 출력 인코딩 설정

python scripts\run_previous_year_plan_update.py

# 에러 처리
if errorlevel 1 (
    # 실패 메시지 출력 후 종료
)
```

**주요 기능:**
- 환경 설정 (인코딩, 디렉토리)
- Python 스크립트 실행
- 에러 처리 및 상태 확인

---

## 🐍 Python 스크립트 로직

### 파일: `scripts/run_previous_year_plan_update.py`

### 전체 프로세스 (5단계)

```
┌─────────────────────────────────────────────────────────┐
│  Step 1: 전년 데이터 다운로드 (Snowflake)               │
│  Step 2: 전년 데이터 전처리                             │
│  Step 3: 계획 데이터 전처리                             │
│  Step 4: 전년 누적 매출 다운로드 (Snowflake)            │
│  Step 5: 진척일수 계산                                  │
└─────────────────────────────────────────────────────────┘
```

---

### Step 1: 전년 데이터 다운로드

**스크립트:** `scripts/download_previous_year_rawdata.py`

**입력:**
- 분석월 (YYYYMM 형식, 예: `202511`)
- `raw` 폴더에서 최신 YYYYMM 폴더 자동 감지

**처리:**
- Snowflake에서 전년도 데이터 다운로드
- 기준일: 분석월의 동일 주차 전년 데이터

**출력:**
- `raw/{YYYYMM}/previous_year/rawdata_{YYYYMM}_ALL.csv`

---

### Step 2: 전년 데이터 전처리

**스크립트:** `scripts/process_previous_year_rawdata.py`

**입력:**
- `raw/{YYYYMM}/previous_year/rawdata_{YYYYMM}_ALL.csv`

**처리:**
1. 데이터 로드 및 컬럼 표준화
2. 브랜드 코드 매핑
3. 채널명 표준화
4. 마스터 데이터 매핑 (브랜드, 아이템, 채널)
5. 집계 기준별 데이터 생성:
   - Shop (채널별 집계)
   - Shop_Item (채널별 아이템별 집계)

**출력:**
- `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_전처리완료.csv`
- `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_Shop.csv`
- `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_Shop_Item.csv`

---

### Step 3: 계획 데이터 전처리

**스크립트:** `scripts/process_plan_data.py`

**입력:**
- 분석월 (YYYYMM 형식)
- 계획 데이터 파일 (Excel 또는 CSV)

**처리:**
1. 계획 데이터 로드
2. 브랜드 코드 매핑
3. 채널명 표준화
4. 마스터 데이터 매핑
5. 데이터 구조 표준화

**출력:**
- `raw/{YYYYMM}/plan/plan_{YYYYMM}_전처리완료.csv`

**주요 컬럼:**
- 브랜드, 채널명
- TAG가(목표), 실판매액(목표)
- 할인율(목표), 직접이익(목표)
- 직접이익율(목표), 영업이익(목표)

---

### Step 4: 전년 누적 매출 다운로드

**스크립트:** `scripts/download_previous_year_cumulative_sales.py`

**입력:**
- 분석월 (YYYYMM 형식)

**처리:**
- Snowflake에서 전년도 누적 매출 데이터 다운로드
- 시즌별 누적 매출 집계

**출력:**
- `raw/{YYYYMM}/previous_year/cumulative_sales_*.csv`

**용도:**
- 전년 대비 매출 성장률 계산
- 누적 매출 추이 분석

---

### Step 5: 진척일수 계산

**스크립트:** `scripts/calculate_progress_days.py`

**입력:**
- 분석월 (YYYYMM 형식)
- 계획 데이터 및 전년 데이터

**처리:**
1. 분석월의 시작일/종료일 계산
2. 현재 시점까지 경과 일수 계산
3. 월 전체 일수 대비 진척률 계산
4. 계획 대비 진척률 계산

**출력:**
- `raw/{YYYYMM}/previous_year/progress_days_{YYYYMM}.csv`

**주요 컬럼:**
- 분석월, 시작일, 종료일
- 현재일, 경과일수, 전체일수
- 진척률(%), 계획대비 진척률(%)

---

## 📁 생성 파일 구조

```
raw/
└── {YYYYMM}/
    ├── previous_year/
    │   ├── rawdata_{YYYYMM}_ALL.csv                    # Step 1 출력
    │   ├── previous_rawdata_{YYYYMM}_전처리완료.csv   # Step 2 출력
    │   ├── previous_rawdata_{YYYYMM}_Shop.csv          # Step 2 출력
    │   ├── previous_rawdata_{YYYYMM}_Shop_Item.csv     # Step 2 출력
    │   ├── cumulative_sales_*.csv                      # Step 4 출력
    │   └── progress_days_{YYYYMM}.csv                  # Step 5 출력
    └── plan/
        └── plan_{YYYYMM}_전처리완료.csv                # Step 3 출력
```

---

## 🔄 실행 플로우

```
1. 배치 파일 실행
   ↓
2. 분석월 자동 감지 (raw 폴더에서 최신 YYYYMM 폴더)
   ↓
3. Step 1 실행: 전년 데이터 다운로드
   ↓ (성공 시)
4. Step 2 실행: 전년 데이터 전처리
   ↓ (성공 시)
5. Step 3 실행: 계획 데이터 전처리
   ↓ (성공 시)
6. Step 4 실행: 전년 누적 매출 다운로드
   ↓ (성공 시)
7. Step 5 실행: 진척일수 계산
   ↓
8. 완료 메시지 및 생성 파일 목록 출력
```

---

## ⚠️ 주의사항

### 필수 조건
1. **분석월 폴더 존재**: `raw/{YYYYMM}` 폴더가 있어야 함
2. **Snowflake 연결**: Step 1, Step 4에서 Snowflake 접속 필요
3. **마스터 파일**: `Master/` 폴더에 다음 파일 필요:
   - `브랜드마스터.csv`
   - `아이템마스터.csv`
   - `채널마스터.csv`

### 실행 순서
- **반드시 먼저 실행**: 전년/계획 데이터 준비는 당년 데이터 처리 전에 필요
- **직접비율 추출 제외**: 직접비율 추출은 `당년데이터_처리실행.bat`에서 수행

### 에러 처리
- 각 Step 실패 시 즉시 중단
- 에러 코드 반환 후 배치 파일 종료
- 실패한 Step의 에러 메시지 출력

---

## 🔗 관련 파일

### 입력 데이터
- Snowflake 데이터베이스 (전년 데이터)
- 계획 Excel/CSV 파일

### 마스터 파일
- `Master/브랜드마스터.csv`
- `Master/아이템마스터.csv`
- `Master/채널마스터.csv`

### 후속 스크립트
- `당년데이터_처리실행.bat`: 당년 데이터 처리 및 직접비율 추출
- `scripts/update_brand_kpi.py`: 브랜드별 KPI 계산
- `scripts/update_overview_data.py`: 전체 현황 데이터 업데이트

---

## 📊 데이터 흐름도

```
[Snowflake]                [Excel/CSV]
     │                          │
     ├─ Step 1: 전년 데이터     │
     │      다운로드             │
     ↓                          │
[rawdata_ALL.csv]              │
     │                          │
     ├─ Step 2: 전년 데이터     │
     │      전처리               │
     ↓                          │
[previous_rawdata_*.csv]       │
     │                          │
     │                    ┌─────┘
     │                    │
     │              Step 3: 계획 데이터
     │                    전처리
     │                    ↓
     │              [plan_전처리완료.csv]
     │                    │
     ├─ Step 4: 누적 매출 ─┘
     │      다운로드
     ↓
[cumulative_sales_*.csv]
     │
     ├─ Step 5: 진척일수
     │      계산
     ↓
[progress_days.csv]
```

---

## ✅ 실행 확인 체크리스트

각 Step 완료 후 다음 파일들이 생성되었는지 확인:

- [ ] `raw/{YYYYMM}/previous_year/rawdata_{YYYYMM}_ALL.csv`
- [ ] `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_전처리완료.csv`
- [ ] `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_Shop.csv`
- [ ] `raw/{YYYYMM}/previous_year/previous_rawdata_{YYYYMM}_Shop_Item.csv`
- [ ] `raw/{YYYYMM}/plan/plan_{YYYYMM}_전처리완료.csv`
- [ ] `raw/{YYYYMM}/previous_year/cumulative_sales_*.csv`
- [ ] `raw/{YYYYMM}/previous_year/progress_days_{YYYYMM}.csv`

---

## 🐛 문제 해결

### 분석월 폴더를 찾을 수 없음
- `raw` 폴더에 `YYYYMM` 형식의 폴더가 있는지 확인
- 예: `raw/202511/` 폴더 존재 여부 확인

### Snowflake 연결 실패
- Step 1 또는 Step 4에서 실패
- Snowflake 연결 정보 확인
- 네트워크 연결 확인

### 전처리 파일이 생성되지 않음
- Step 2 또는 Step 3에서 실패
- 마스터 파일 경로 확인
- CSV 파일 형식 확인










